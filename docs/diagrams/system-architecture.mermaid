flowchart LR
    subgraph CONTROL["Control Plane"]
        direction TB
        CLI["ironpost-cli\nscan · monitor · guard\nlogs · status"]
        DAEMON["ironpost-daemon"]
        CONFIG["Config Loader"]
        REGISTRY["Plugin Registry"]
        METRICS_SRV["Metrics Server"]
    end

    subgraph MODULES["Security Modules"]
        direction TB
        EBPF["ebpf-engine\nAya XDP + Traffic Monitor"]
        LOG["log-pipeline\ncollect · parse · detect · alert"]
        GUARD["container-guard\ndocker watch · policy · isolate"]
        SBOM["sbom-scanner\nlockfile parse · sbom · cve"]
    end

    subgraph CORE["Shared Core"]
        direction TB
        CORE_NODE["ironpost-core\nevent model · traits · errors"]
        CHANNELS["tokio::mpsc\nbounded channels"]
    end

    subgraph OBS["Observability"]
        direction TB
        PROM["Prometheus"]
        GRAF["Grafana Dashboards"]
    end

    CLI -->|commands| DAEMON
    DAEMON --> CONFIG
    DAEMON --> REGISTRY
    DAEMON --> METRICS_SRV

    REGISTRY --> EBPF
    REGISTRY --> LOG
    REGISTRY --> GUARD
    REGISTRY --> SBOM

    EBPF -.implements shared traits.-> CORE_NODE
    LOG -.implements shared traits.-> CORE_NODE
    GUARD -.implements shared traits.-> CORE_NODE
    SBOM -.implements shared traits.-> CORE_NODE
    CORE_NODE --> CHANNELS

    METRICS_SRV -->|exports metrics| PROM
    PROM --> GRAF

    classDef control fill:#e8f5e9,stroke:#2e7d32,stroke-width:1px,color:#1b5e20;
    classDef module fill:#fff8e1,stroke:#ef6c00,stroke-width:1px,color:#e65100;
    classDef core fill:#e3f2fd,stroke:#1565c0,stroke-width:1px,color:#0d47a1;
    classDef obs fill:#f3e5f5,stroke:#6a1b9a,stroke-width:1px,color:#4a148c;

    class CLI,DAEMON,CONFIG,REGISTRY,METRICS_SRV control;
    class EBPF,LOG,GUARD,SBOM module;
    class CORE_NODE,CHANNELS core;
    class PROM,GRAF obs;
