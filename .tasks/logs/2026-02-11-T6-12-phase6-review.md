# T6-12: Phase 6 Integration Review Fixes

**Date**: 2026-02-11
**Agent**: implementer
**Task**: Fix all Critical and High severity issues from Phase 6 review
**Estimated Time**: 2h
**Actual Time**: 1h
**Status**: ✅ Complete

## Summary

Fixed 7 Critical and High severity issues identified in Phase 6 Integration code review (.reviews/phase-6-integration.md):
- 2 Critical issues (TOCTOU race condition, expect() in signal handlers)
- 5 High issues (unsafe cast, incomplete SAFETY comment, expect() in production, wrong shutdown order, credential exposure)

All fixes follow CLAUDE.md rules: no unwrap/expect in production, proper error handling, safe type conversions.

## Issues Fixed

### Critical Issues (2)

#### C1 (P6-C1): TOCTOU in PID File Creation
- **File**: ironpost-daemon/src/orchestrator.rs:268-293
- **Problem**: Race condition between path.exists() check and File::create()
- **Fix**: Replaced with atomic OpenOptions::new().write(true).create_new(true).open(path)
- **Impact**: Eliminates race window where two daemon instances could both believe they're sole instance

#### C2 (P6-C2): Signal Handler expect()
- **File**: ironpost-daemon/src/orchestrator.rs:246-259
- **Problem**: .expect() on signal handler installation violates no-unwrap rule
- **Fix**: Changed wait_for_shutdown_signal() to return Result<&'static str>, use .map_err() + ?
- **Impact**: Graceful error handling instead of panic in restricted environments

### High Issues (5)

#### H1 (P6-H1): as Cast Without Overflow Check
- **File**: ironpost-cli/src/commands/status.rs:161-179
- **Problem**: `pid as libc::pid_t` can wrap u32 > i32::MAX to negative (process group signal)
- **Fix**: libc::pid_t::try_from(pid) with explicit error handling
- **Impact**: Prevents unintended process group signaling

#### H2 (P6-H2): Incomplete unsafe SAFETY Comment
- **File**: ironpost-cli/src/commands/status.rs:161-179
- **Problem**: SAFETY comment didn't cover cast validity, PID semantics
- **Fix**: Expanded to cover: (1) try_from check, (2) signal 0 semantics, (3) PID recycling, (4) extern C safety
- **Impact**: Proper unsafe justification per project rules

#### H3 (P6-H3): expect() in Container Guard
- **File**: ironpost-daemon/src/modules/container_guard.rs:67-71
- **Problem**: .expect() on action_rx in production code
- **Fix**: action_rx.ok_or_else(|| anyhow!("builder did not produce action_rx"))?
- **Impact**: Proper error propagation instead of panic

#### H4 (P6-H4): Shutdown Order Backwards
- **File**: ironpost-daemon/src/modules/mod.rs:102-135, orchestrator.rs:14-19
- **Problem**: stop_all() used .rev() (consumers stop first), contradicting comments
- **Fix**: Removed .rev() to stop in registration order (producers first: eBPF → Log → SBOM → Container)
- **Impact**: Consumers can drain remaining channel events before shutdown

#### H5 (P6-H5): Credential Exposure in config show
- **File**: ironpost-cli/src/commands/config.rs:54-116
- **Problem**: postgres_url and redis_url with embedded credentials dumped to stdout
- **Fix**: Added redact_credentials() to replace user:password with ***REDACTED***
- **Impact**: Prevents credential exposure in terminal scrollback, logs, CI/CD pipelines

## Code Changes

### Files Modified (5)
1. ironpost-daemon/src/orchestrator.rs
   - write_pid_file(): atomic create_new(true)
   - wait_for_shutdown_signal(): return Result
   - shutdown order comments updated

2. ironpost-daemon/src/modules/mod.rs
   - stop_all(): removed .rev()
   - Updated comments to reflect forward-order shutdown

3. ironpost-daemon/src/modules/container_guard.rs
   - init(): replaced .expect() with .ok_or_else()

4. ironpost-cli/src/commands/status.rs
   - is_process_alive(): try_from instead of as cast
   - Expanded SAFETY comment

5. ironpost-cli/src/commands/config.rs
   - Added redact_credentials() and redact_url()
   - Applied to execute_show()

### Review File Created (1)
- .reviews/phase-6-integration.md (410 lines)
  - Full review findings with ✅ fix annotations

## Testing

### Unit Tests (All Passed)
```bash
cargo test -p ironpost-daemon orchestrator
# Result: 7 passed

cargo test -p ironpost-cli commands::status
# Result: 15 passed

cargo test -p ironpost-cli commands::config
# Result: 12 passed
```

### Clippy (Clean)
```bash
cargo clippy -p ironpost-daemon -p ironpost-cli -- -D warnings
# Result: Finished `dev` profile, no warnings
```

### Build (Success)
```bash
cargo check --all-targets
# Result: Finished `dev` profile
```

## Statistics

- **Issues Fixed**: 7 (2 Critical, 5 High)
- **Files Modified**: 6 (5 source + 1 review)
- **Lines Added**: 525
- **Lines Removed**: 47
- **Net Change**: +478 lines
- **Commit**: 8dc6a33

## Commit Message
```
fix(review): resolve Phase 6 Critical and High severity issues

## Critical Issues Fixed (2)
C1: TOCTOU in PID file creation
C2: Signal handler expect()

## High Issues Fixed (5)
H1: as cast without overflow check
H2: Incomplete unsafe SAFETY comment
H3: expect() in container guard
H4: Shutdown order backwards
H5: Credential exposure in config show

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
```

## Notes

### Pattern Improvements
1. **Atomic File Operations**: OpenOptions::create_new(true) eliminates TOCTOU
2. **Safe Type Conversion**: try_from instead of as casting
3. **Comprehensive SAFETY Comments**: All four aspects covered
4. **Credential Redaction**: Pattern for sensitive data masking
5. **Proper Shutdown Order**: Producers first, consumers drain

### Remaining Medium/Low Issues
- Not addressed in this task (out of scope for Critical/High-only fix)
- P6-M1 through P6-M8 (8 Medium issues)
- P6-L1 through P6-L9 (9 Low issues)
- To be addressed in future polish tasks if needed

## Task Board Update

Updated .tasks/BOARD.md:
- T6-12 status: ✅ Complete
- Phase 6 progress: 12 tasks total, 5 complete
- Next: T6-3 (ironpost.toml integrated config file)
