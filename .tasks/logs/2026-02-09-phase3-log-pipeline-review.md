# Phase 3 Log Pipeline 코드 리뷰

**날짜**: 2026-02-09
**역할**: reviewer
**작업 시간**: 22:20 - 22:45 (약 25분)

## 작업 개요
Phase 3 log-pipeline 크레이트의 전체 소스 코드를 보안 및 코드 품질 관점에서 리뷰 수행.

## 리뷰 범위
- `crates/log-pipeline/src/` 전체 (15개 파일, 약 6,000 LOC)
- `tests/integration_tests.rs` (279 LOC)
- 총 266개 테스트 (253 unit + 13 integration)

## 발견 사항 요약
총 **38건** 발견:
- 🔴 Critical: 10건 (프로덕션 투입 전 필수 수정)
- 🟠 High: 8건 (수정 강력 권장)
- 🟡 Medium: 11건 (수정 권장)
- 🟢 Low: 9건 (선택적 개선)

## 주요 Critical 이슈
1. **C1**: `Arc<Mutex<u64>>` 카운터 → `AtomicU64`로 변경 (성능 병목)
2. **C2**: 배치 처리 로직 127라인 중복 (유지보수성)
3. **C3**: `as` 캐스팅 사용 (프로젝트 규칙 위반)
4. **C4**: 파일 라인 길이 무제한 (OOM 취약점)
5. **C5**: TCP slow loris 메모리 고갈 취약점
6. **C6**: JSON 재귀 깊이 제한 없음 (스택 오버플로우)
7. **C7**: HashMap 무제한 성장 (메모리 DoS)
8. **C8**: 정규식 lookup 시 매번 allocation
9. **C9**: capacity 0 버퍼 비직관적 동작
10. **C10**: flush_interval 정수 오버플로우

## 주요 High 이슈
- **H1**: Detector trait과 RuleEngine 시그니처 불일치 (`&self` vs `&mut self`)
- **H2**: 설정 상한값 검증 부재 (batch_size, buffer_capacity 등)
- **H3**: ReDoS 취약점 (사용자 정규식 패턴 검증 없음)
- **H4**: PRI 값 범위 검증 부재 (0-191만 유효)
- **H5**: 타임스탬프 휴리스틱 불완전 (마이크로초/나노초 미지원)
- **H6**: 파일 경로 순회 검증 없음
- **H7**: SystemTime 역행 위험 (중복 제거/속도 제한 오동작)
- **H8**: stop() 메서드 레이스 컨디션

## 보안 취약점 분석
1. **메모리 고갈 공격**: C4, C5, C6, C7, M10
2. **정규식 DoS**: H3
3. **입력 검증 부재**: H2, H4, H6, M5
4. **시간 기반 공격**: H7, M7
5. **레이스 컨디션**: H8

## 잘된 점
- 266개 테스트로 엣지 케이스까지 검증
- `thiserror` 기반 명확한 에러 정의
- 트레이트 기반 확장 가능한 아키텍처
- 상세한 문서화 주석
- 빌더 패턴 활용
- 기본 보안 장치 (파일 크기 제한, 연결 수 제한 등)

## 산출물
- `.reviews/phase-3-log-pipeline.md` (약 1,200 라인)
  - 38건의 상세한 문제점 분석
  - 각 이슈별 수정 방안 제시
  - 우선순위별 수정 권고사항
  - 코드 예시 포함

## 다음 단계
1. implementer에게 리뷰 결과 전달
2. Critical 10건 + High 8건 우선 수정
3. 수정 완료 후 재검토

## 비고
- Phase 2 (ebpf-engine) 대비 발견된 이슈가 더 많음 (28건 → 38건)
- 주된 원인: 더 많은 외부 입력 처리 (파일, 네트워크, 정규식)
- 프로덕션 투입 전 반드시 Critical + High 이슈 수정 필요
