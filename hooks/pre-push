#!/bin/bash
# Ironpost Pre-push Hook
# Push ì „ ë¬´ê±°ìš´ ê²€ì‚¬ ìˆ˜í–‰ (í…ŒìŠ¤íŠ¸, ë¬¸ì„œ ë“±)
# git push --no-verify ë¡œ ìš°íšŒ ê°€ëŠ¥ (ê¸´ê¸‰ ìƒí™© ì‹œì—ë§Œ ì‚¬ìš©)

set -e  # í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ ì¦‰ì‹œ ì¢…ë£Œ

echo "ğŸ” Running pre-push checks..."
echo ""

# 1. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
echo "ğŸ§ª Running tests..."
if ! cargo test --workspace; then
    echo ""
    echo "âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!"
    echo "   ëª¨ë“  í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í•´ì•¼ pushí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
    echo ""
    exit 1
fi
echo "âœ… Tests OK"
echo ""

# 2. ë¬¸ì„œ ìƒì„± ê²€ì¦
echo "ğŸ“š Checking documentation..."
if ! cargo doc --workspace --no-deps --document-private-items 2>&1 | grep -v "^warning: unused"; then
    echo ""
    echo "âŒ ë¬¸ì„œ ìƒì„± ì‹¤íŒ¨!"
    echo "   ë¬¸ì„œ ì£¼ì„ì„ í™•ì¸í•˜ì„¸ìš”."
    echo ""
    exit 1
fi
echo "âœ… Documentation OK"
echo ""

# 3. ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬ (ì„ íƒì )
# í™œì„±í™”í•˜ë ¤ë©´ ì£¼ì„ í•´ì œí•˜ì„¸ìš”. cargo-audit ì„¤ì¹˜ í•„ìš”: cargo install cargo-audit
# echo "ğŸ”’ Checking security vulnerabilities..."
# if ! cargo audit; then
#     echo ""
#     echo "âš ï¸  ë³´ì•ˆ ì·¨ì•½ì  ë°œê²¬!"
#     echo "   ì˜ì¡´ì„±ì„ ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜ advisoryë¥¼ í™•ì¸í•˜ì„¸ìš”."
#     echo "   ê¸´ê¸‰í•œ ê²½ìš°: git push --no-verify"
#     echo ""
#     exit 1
# fi
# echo "âœ… Security audit OK"
# echo ""

echo "ğŸ‰ All pre-push checks passed!"
echo "   Proceeding with push..."
echo ""
