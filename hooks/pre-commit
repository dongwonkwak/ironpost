#!/bin/bash
# Ironpost Pre-commit Hook
# ì»¤ë°‹ ì „ í•„ìˆ˜ ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
# git commit --no-verify ë¡œ ìš°íšŒ ê°€ëŠ¥ (ê¸´ê¸‰ ìƒí™© ì‹œì—ë§Œ ì‚¬ìš©)

set -e  # í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ ì¦‰ì‹œ ì¢…ë£Œ

echo "ğŸ” Running pre-commit checks..."
echo ""

# 1. í¬ë§·íŒ… ê²€ì‚¬
echo "ğŸ“ Checking code formatting..."
if ! cargo fmt --all --check; then
    echo ""
    echo "âŒ í¬ë§·íŒ… ì˜¤ë¥˜ ë°œê²¬!"
    echo "   ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ìˆ˜ì •í•˜ì„¸ìš”:"
    echo "   cargo fmt --all"
    echo ""
    exit 1
fi
echo "âœ… Formatting OK"
echo ""

# 2. Clippy ê²€ì‚¬ (ê²½ê³ ë¥¼ ì—ëŸ¬ë¡œ ì²˜ë¦¬)
echo "ğŸ”§ Running clippy..."
if ! cargo clippy --workspace --all-targets -- -D warnings; then
    echo ""
    echo "âŒ Clippy ì˜¤ë¥˜ ë°œê²¬!"
    echo "   ì½”ë“œë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜ ì •ë‹¹í•œ ê²½ìš° #[allow(...)] ì‚¬ìš©"
    echo ""
    exit 1
fi
echo "âœ… Clippy OK"
echo ""

# 3. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
echo "ğŸ§ª Running tests..."
if ! cargo test --workspace; then
    echo ""
    echo "âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!"
    echo "   ëª¨ë“  í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í•´ì•¼ ì»¤ë°‹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
    echo ""
    exit 1
fi
echo "âœ… Tests OK"
echo ""

# 4. ë¬¸ì„œ ìƒì„± ê²€ì¦
echo "ğŸ“š Checking documentation..."
if ! cargo doc --workspace --no-deps --document-private-items 2>&1 | grep -v "^warning: unused"; then
    echo ""
    echo "âŒ ë¬¸ì„œ ìƒì„± ì‹¤íŒ¨!"
    echo "   ë¬¸ì„œ ì£¼ì„ì„ í™•ì¸í•˜ì„¸ìš”."
    echo ""
    exit 1
fi
echo "âœ… Documentation OK"
echo ""

# 5. ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬ (ì„ íƒì , ëŠë¦´ ìˆ˜ ìˆìŒ)
# í™œì„±í™”í•˜ë ¤ë©´ ì£¼ì„ í•´ì œí•˜ì„¸ìš”. cargo-audit ì„¤ì¹˜ í•„ìš”: cargo install cargo-audit
# echo "ğŸ”’ Checking security vulnerabilities..."
# if ! cargo audit; then
#     echo ""
#     echo "âš ï¸  ë³´ì•ˆ ì·¨ì•½ì  ë°œê²¬!"
#     echo "   ì˜ì¡´ì„±ì„ ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜ advisoryë¥¼ í™•ì¸í•˜ì„¸ìš”."
#     echo "   ê¸´ê¸‰í•œ ê²½ìš°: git commit --no-verify"
#     echo ""
#     exit 1
# fi
# echo "âœ… Security audit OK"
# echo ""

echo "ğŸ‰ All pre-commit checks passed!"
echo "   Proceeding with commit..."
echo ""
