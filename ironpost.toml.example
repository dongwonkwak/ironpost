# =============================================================================
# Ironpost 통합 설정 파일 (ironpost.toml)
# =============================================================================
#
# Ironpost 보안 모니터링 플랫폼의 전체 설정 예시입니다.
# 복사하여 ironpost.toml로 사용하세요:
#
#   cp ironpost.toml.example ironpost.toml
#
# 설정 로딩 우선순위 (높은 순):
#   1. CLI 인자        (--log-level, --config 등)
#   2. 환경변수        (IRONPOST_{SECTION}_{FIELD})
#   3. 설정 파일       (ironpost.toml)
#   4. 기본값          (코드 내 Default 구현)
#
# 부분 설정 지원:
#   필요한 섹션만 작성해도 됩니다. 생략된 섹션/필드는 기본값이 적용됩니다.
#
# 설정 검증:
#   ironpost config validate --config ironpost.toml
#
# =============================================================================


# -----------------------------------------------------------------------------
# [general] — 일반 설정
# -----------------------------------------------------------------------------
[general]

# 로그 레벨
# 타입: String
# 허용값: "trace", "debug", "info", "warn", "error"
# 기본값: "info"
# 환경변수: IRONPOST_GENERAL_LOG_LEVEL
log_level = "info"

# 로그 출력 형식
# 타입: String
# 허용값: "json" (구조화 로그), "pretty" (사람 읽기용)
# 기본값: "json"
# 환경변수: IRONPOST_GENERAL_LOG_FORMAT
log_format = "json"

# 데이터 디렉토리 (내부 상태, DB 등)
# 타입: String
# 기본값: "/var/lib/ironpost"
# 환경변수: IRONPOST_GENERAL_DATA_DIR
data_dir = "/var/lib/ironpost"

# PID 파일 경로 (중복 실행 방지)
# 타입: String
# 기본값: "/var/run/ironpost/ironpost.pid"
# 환경변수: IRONPOST_GENERAL_PID_FILE
pid_file = "/var/run/ironpost/ironpost.pid"


# -----------------------------------------------------------------------------
# [ebpf] — eBPF XDP 네트워크 패킷 엔진 (Linux 전용)
# -----------------------------------------------------------------------------
# 네트워크 패킷을 XDP로 캡처하여 이상 징후(SYN flood, 포트 스캔)를 탐지하고
# PacketEvent를 로그 파이프라인에 전달합니다.
#
# 요구사항: Linux 커널 5.7+, CAP_BPF 또는 root 권한
# 비Linux 플랫폼에서는 무시됩니다.
[ebpf]

# 모듈 활성화 여부
# 타입: bool
# 기본값: false
# 환경변수: IRONPOST_EBPF_ENABLED
enabled = false

# 감시할 네트워크 인터페이스
# 타입: String
# 기본값: "eth0"
# 환경변수: IRONPOST_EBPF_INTERFACE
# 참고: enabled=true일 때 비어있으면 검증 실패
interface = "eth0"

# XDP 모드
# 타입: String
# 허용값: "native" (드라이버 레벨), "skb" (범용), "hw" (하드웨어 오프로드)
# 기본값: "skb"
# 환경변수: IRONPOST_EBPF_XDP_MODE
# 참고: "skb"는 호환성 최대, "native"는 성능 최대
xdp_mode = "skb"

# 이벤트 링 버퍼 크기 (바이트)
# 타입: usize
# 기본값: 262144 (256KB)
# 환경변수: IRONPOST_EBPF_RING_BUFFER_SIZE
# 참고: 값이 클수록 높은 패킷 속도에서 이벤트 손실 감소
#       enabled=true일 때 0이면 검증 실패
ring_buffer_size = 262144

# 차단 목록 최대 엔트리 수 (eBPF HashMap)
# 타입: usize
# 기본값: 10000
# 환경변수: IRONPOST_EBPF_BLOCKLIST_MAX_ENTRIES
# 참고: enabled=true일 때 0이면 검증 실패
blocklist_max_entries = 10000


# -----------------------------------------------------------------------------
# [log_pipeline] — 로그 수집/분석 파이프라인
# -----------------------------------------------------------------------------
# 다중 소스에서 로그를 수집하고, 파싱(syslog RFC 5424, JSON)한 뒤
# YAML 탐지 규칙과 매칭하여 AlertEvent를 생성합니다.
[log_pipeline]

# 모듈 활성화 여부
# 타입: bool
# 기본값: true
# 환경변수: IRONPOST_LOG_PIPELINE_ENABLED
enabled = true

# 수집 소스 목록
# 타입: Vec<String>
# 허용값: "syslog", "file"
# 기본값: ["syslog", "file"]
# 환경변수: IRONPOST_LOG_PIPELINE_SOURCES (CSV 형식, 예: "syslog,file")
# 참고: enabled=true일 때 최소 1개 필요
sources = ["syslog", "file"]

# Syslog 수신 바인드 주소 (UDP/TCP)
# 타입: String
# 기본값: "0.0.0.0:514"
# 환경변수: IRONPOST_LOG_PIPELINE_SYSLOG_BIND
syslog_bind = "0.0.0.0:514"

# 파일 감시 경로 목록
# 타입: Vec<String>
# 기본값: ["/var/log/syslog"]
# 환경변수: IRONPOST_LOG_PIPELINE_WATCH_PATHS (CSV 형식)
# 참고: 절대 경로만 허용, ".." 포함 불가, /var/log 또는 /tmp 하위만 허용
watch_paths = ["/var/log/syslog"]

# 배치 크기 (이벤트 수)
# 타입: usize
# 범위: 1 ~ 10,000
# 기본값: 100
# 환경변수: IRONPOST_LOG_PIPELINE_BATCH_SIZE
batch_size = 100

# 배치 플러시 간격 (초)
# 타입: u64
# 범위: 1 이상
# 기본값: 5
# 환경변수: IRONPOST_LOG_PIPELINE_FLUSH_INTERVAL_SECS
flush_interval_secs = 5


# -----------------------------------------------------------------------------
# [log_pipeline.storage] — 로그 스토리지 설정
# -----------------------------------------------------------------------------
[log_pipeline.storage]

# PostgreSQL 연결 문자열
# 타입: String
# 기본값: "postgresql://localhost:5432/ironpost"
# 환경변수: IRONPOST_STORAGE_POSTGRES_URL
# 주의: 비밀번호 포함 시 환경변수 사용 권장
postgres_url = "postgresql://localhost:5432/ironpost"

# Redis 연결 문자열 (캐시/큐)
# 타입: String
# 기본값: "redis://localhost:6379"
# 환경변수: IRONPOST_STORAGE_REDIS_URL
redis_url = "redis://localhost:6379"

# 로그 보존 기간 (일)
# 타입: u32
# 범위: 1 ~ 3,650 (10년)
# 기본값: 30
# 환경변수: IRONPOST_STORAGE_RETENTION_DAYS
retention_days = 30


# -----------------------------------------------------------------------------
# [container] — 컨테이너 격리 가드
# -----------------------------------------------------------------------------
# Docker 컨테이너를 모니터링하고, AlertEvent에 대해 보안 정책을 평가하여
# 격리 액션(pause, stop, network disconnect)을 실행합니다.
#
# 요구사항: Docker 데몬 접근 (소켓 또는 TCP)
[container]

# 모듈 활성화 여부
# 타입: bool
# 기본값: false
# 환경변수: IRONPOST_CONTAINER_ENABLED
enabled = false

# Docker 소켓 경로
# 타입: String
# 기본값: "/var/run/docker.sock"
# 환경변수: IRONPOST_CONTAINER_DOCKER_SOCKET
# 참고: enabled=true일 때 비어있으면 검증 실패
docker_socket = "/var/run/docker.sock"

# 컨테이너 목록 폴링 주기 (초)
# 타입: u64
# 범위: 1 ~ 3,600
# 기본값: 10
# 환경변수: IRONPOST_CONTAINER_POLL_INTERVAL_SECS
poll_interval_secs = 10

# 격리 정책 TOML 파일 디렉토리
# 타입: String
# 기본값: "/etc/ironpost/policies"
# 환경변수: IRONPOST_CONTAINER_POLICY_PATH
policy_path = "/etc/ironpost/policies"

# 자동 격리 활성화
# 타입: bool
# 기본값: false
# 환경변수: IRONPOST_CONTAINER_AUTO_ISOLATE
# 주의: 프로덕션에서 신중히 활성화. 정책 테스트 후 사용 권장
auto_isolate = false


# -----------------------------------------------------------------------------
# [sbom] — SBOM 생성 및 취약점 스캔
# -----------------------------------------------------------------------------
# lockfile(Cargo.lock, package-lock.json)을 탐색하여 SBOM 문서를 생성하고
# (CycloneDX, SPDX), 로컬 취약점 DB와 대조하여 CVE를 검출합니다.
[sbom]

# 모듈 활성화 여부
# 타입: bool
# 기본값: false
# 환경변수: IRONPOST_SBOM_ENABLED
enabled = false

# 스캔 대상 디렉토리 목록 (비재귀, 직계 파일만)
# 타입: Vec<String>
# 기본값: ["."]
# 환경변수: IRONPOST_SBOM_SCAN_DIRS (CSV 형식, 예: "/app,/opt")
# 참고: ".." 포함 불가, enabled=true일 때 최소 1개 필요
scan_dirs = ["."]

# 취약점 DB 업데이트 주기 (시간)
# 타입: u32
# 범위: 1 ~ 8,760 (1년)
# 기본값: 24
# 환경변수: IRONPOST_SBOM_VULN_DB_UPDATE_HOURS
vuln_db_update_hours = 24

# 로컬 취약점 DB 저장 경로
# 타입: String
# 기본값: "/var/lib/ironpost/vuln-db"
# 환경변수: IRONPOST_SBOM_VULN_DB_PATH
vuln_db_path = "/var/lib/ironpost/vuln-db"

# 최소 심각도 알림 수준
# 타입: String
# 허용값: "info", "low", "medium", "high", "critical"
# 기본값: "medium"
# 환경변수: IRONPOST_SBOM_MIN_SEVERITY
min_severity = "medium"

# SBOM 출력 형식
# 타입: String
# 허용값: "spdx" (SPDX 2.3), "cyclonedx" (CycloneDX 1.5)
# 기본값: "cyclonedx"
# 환경변수: IRONPOST_SBOM_OUTPUT_FORMAT
output_format = "cyclonedx"


# -----------------------------------------------------------------------------
# [metrics] — Prometheus 메트릭 노출 (선택사항)
# -----------------------------------------------------------------------------
# Prometheus 메트릭 엔드포인트를 노출하여 Grafana 대시보드에서 모니터링합니다.
# 29개 메트릭: eBPF, 로그 파이프라인, 컨테이너 격리, SBOM 스캐너, 데몬 상태
#
# 요구사항: enabled=true일 때 유효한 listen_addr와 port 필수
# Docker 환경: listen_addr을 "0.0.0.0"으로 설정하여 컨테이너 외부에서 접근 가능하게 함
[metrics]

# 메트릭 노출 활성화 여부
# 타입: bool
# 기본값: false
# 환경변수: IRONPOST_METRICS_ENABLED
enabled = false

# 메트릭 엔드포인트 바인드 주소 (localhost 권장)
# 타입: String
# 기본값: "127.0.0.1"
# 환경변수: IRONPOST_METRICS_LISTEN_ADDR
# 주의: Docker 환경에서 호스트에서 접근하려면 "0.0.0.0" 사용
listen_addr = "127.0.0.1"

# 메트릭 엔드포인트 포트
# 타입: u16
# 기본값: 9100
# 환경변수: IRONPOST_METRICS_PORT
# 범위: 1024 ~ 65535 (1024 미만은 root 권한 필요)
port = 9100

# 메트릭 엔드포인트 경로
# 타입: String
# 기본값: "/metrics"
# 환경변수: IRONPOST_METRICS_ENDPOINT
endpoint = "/metrics"
