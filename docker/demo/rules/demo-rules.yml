# =============================================================================
# Ironpost Demo Detection Rules
# =============================================================================
# This file contains detection rules optimized for demonstration.
# Thresholds are intentionally low to trigger alerts quickly.
#
# Rule Format:
#   id: unique_rule_identifier
#   title: Human-readable rule name
#   description: What this rule detects
#   severity: Critical | High | Medium | Low | Info
#   status: enabled | disabled | test
#   detection:
#     conditions: List of field matching conditions (AND logic)
#     threshold: Optional correlation analysis (count events in timeframe)
#   tags: Classification tags

# =============================================================================
# Authentication & Access Control
# =============================================================================

# Rule 1: SSH Brute Force Detection
- id: ssh_brute_force_demo
  title: SSH Brute Force Attempt
  description: Detects multiple failed SSH login attempts from the same source IP
  severity: High
  status: enabled
  detection:
    conditions:
      - field: process
        modifier: exact
        value: sshd
      - field: message
        modifier: contains
        value: "Failed password"
    threshold:
      field: source_ip
      count: 3
      timeframe_secs: 60
  tags:
    - authentication
    - brute_force
    - ssh

# Rule 2: SSH Root Login Attempt
- id: ssh_root_login
  title: SSH Root Login Attempt
  description: Detects attempts to login as root via SSH
  severity: Medium
  status: enabled
  detection:
    conditions:
      - field: process
        modifier: exact
        value: sshd
      - field: message
        modifier: contains
        value: "Failed password for root"
  tags:
    - authentication
    - ssh
    - root_access

# =============================================================================
# Web Application Attacks
# =============================================================================

# Rule 3: SQL Injection Detection
- id: sql_injection_demo
  title: SQL Injection Attempt
  description: Detects common SQL injection patterns in web requests
  severity: Critical
  status: enabled
  detection:
    conditions:
      - field: process
        modifier: exact
        value: nginx
      - field: message
        modifier: regex
        value: "(?i)(union.*select|drop.*table|' or '1'='1|; drop |--)"
  tags:
    - web_attack
    - sql_injection
    - owasp_top10

# Rule 4: XSS Attack Detection
- id: xss_attack
  title: Cross-Site Scripting (XSS) Attempt
  description: Detects XSS attack patterns in web logs
  severity: High
  status: enabled
  detection:
    conditions:
      - field: process
        modifier: exact
        value: nginx
      - field: message
        modifier: regex
        value: "(?i)(<script|javascript:|onerror=|onload=)"
  tags:
    - web_attack
    - xss
    - owasp_top10

# =============================================================================
# Privilege Escalation
# =============================================================================

# Rule 5: Unauthorized Sudo Usage
- id: unauthorized_sudo
  title: Unauthorized Sudo Attempt
  description: Detects unauthorized attempts to use sudo for privilege escalation
  severity: High
  status: enabled
  detection:
    conditions:
      - field: process
        modifier: exact
        value: sudo
      - field: message
        modifier: contains
        value: "unauthorized"
  tags:
    - privilege_escalation
    - sudo
    - access_control

# Rule 6: SUID Binary Execution
- id: suid_execution
  title: SUID Binary Execution
  description: Detects execution of common SUID binaries that may be abused
  severity: Medium
  status: enabled
  detection:
    conditions:
      - field: message
        modifier: regex
        value: "(?i)(chmod.*\\+s|find.*-perm|pkexec|polkit)"
  tags:
    - privilege_escalation
    - suid
    - linux

# =============================================================================
# Suspicious Commands & Lateral Movement
# =============================================================================

# Rule 7: Suspicious Download Commands
- id: suspicious_download
  title: Suspicious Download Activity
  description: Detects wget/curl downloading from suspicious domains or IPs
  severity: High
  status: enabled
  detection:
    conditions:
      - field: message
        modifier: regex
        value: "(?i)(wget|curl).*http"
      - field: message
        modifier: regex
        value: "(?i)(malicious|evil|c2|payload|exploit|\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"
  tags:
    - command_and_control
    - lateral_movement
    - malware_download

# Rule 8: Reverse Shell Detection
- id: reverse_shell
  title: Reverse Shell Attempt
  description: Detects common reverse shell command patterns
  severity: Critical
  status: enabled
  detection:
    conditions:
      - field: message
        modifier: regex
        value: "(?i)(nc.*-e|/bin/bash.*-i|/bin/sh.*-i|python.*pty\\.spawn|perl.*socket)"
  tags:
    - command_and_control
    - reverse_shell
    - post_exploitation

# =============================================================================
# Network Reconnaissance
# =============================================================================

# Rule 9: Port Scan Detection
- id: port_scan_demo
  title: Port Scanning Activity
  description: Detects rapid connection attempts to multiple ports
  severity: Medium
  status: enabled
  detection:
    conditions:
      - field: message
        modifier: regex
        value: "(?i)(SYN packet|connection attempt|port)"
    threshold:
      field: source_ip
      count: 5
      timeframe_secs: 30
  tags:
    - reconnaissance
    - port_scan
    - network

# Rule 10: Network Enumeration
- id: network_enum
  title: Network Enumeration
  description: Detects network scanning tools execution
  severity: Medium
  status: enabled
  detection:
    conditions:
      - field: message
        modifier: regex
        value: "(?i)(nmap|masscan|zmap|netcat|nc -z)"
  tags:
    - reconnaissance
    - network_enum
    - scanning

# =============================================================================
# Data Exfiltration
# =============================================================================

# Rule 11: Compression of Sensitive Files
- id: sensitive_compression
  title: Compression of Sensitive Files
  description: Detects compression of files in sensitive directories
  severity: Medium
  status: enabled
  detection:
    conditions:
      - field: message
        modifier: regex
        value: "(?i)(tar|zip|gzip|7z|rar).*(etc|home|var)"
  tags:
    - data_exfiltration
    - compression
    - suspicious_activity

# Rule 12: Large File Transfer
- id: large_transfer
  title: Large Outbound File Transfer
  description: Detects unusually large outbound file transfers
  severity: Low
  status: enabled
  detection:
    conditions:
      - field: message
        modifier: regex
        value: "(?i)(scp|rsync|ftp|sftp).*outbound"
      - field: message
        modifier: regex
        value: "\\d{4,}\\s*(MB|GB)"
  tags:
    - data_exfiltration
    - file_transfer
    - bandwidth

# =============================================================================
# System Integrity
# =============================================================================

# Rule 13: Critical File Modification
- id: critical_file_mod
  title: Critical System File Modification
  description: Detects modifications to critical system files
  severity: Critical
  status: enabled
  detection:
    conditions:
      - field: message
        modifier: regex
        value: "(?i)(passwd|shadow|sudoers|ssh.*authorized_keys|cron)"
      - field: message
        modifier: regex
        value: "(?i)(modified|changed|edited|written)"
  tags:
    - system_integrity
    - persistence
    - backdoor

# Rule 14: Service Start/Stop
- id: service_manipulation
  title: Suspicious Service Manipulation
  description: Detects starting or stopping of security-related services
  severity: Medium
  status: enabled
  detection:
    conditions:
      - field: process
        modifier: exact
        value: systemd
      - field: message
        modifier: regex
        value: "(?i)(firewall|iptables|selinux|apparmor).*(stopped|disabled)"
  tags:
    - system_integrity
    - defense_evasion
    - service_manipulation

# =============================================================================
# Anomalous Behavior
# =============================================================================

# Rule 15: Off-Hours Activity
- id: off_hours_activity
  title: Off-Hours System Activity
  description: Detects suspicious activity during non-business hours
  severity: Low
  status: disabled
  detection:
    conditions:
      - field: message
        modifier: contains
        value: "off-hours"
  tags:
    - anomaly
    - timing
    - user_behavior
